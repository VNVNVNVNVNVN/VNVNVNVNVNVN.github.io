<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PLAI-STOCK | ë¶„ì„</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    #chartContainer { min-height: 400px; }
    .loading-spinner {
      border: 3px solid #334155;
      border-top: 3px solid #22d3ee;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .analysis-card {
      transition: all 0.3s ease;
    }
    .analysis-card:hover {
      border-color: #22d3ee;
    }
  </style>
</head>
<body>
  <div class="min-h-screen" style="background-color: #1a1a2e;">
    
    <!-- í—¤ë” -->
    <header class="flex items-center justify-between px-6 py-4 border-b" style="border-color: #334155;">
      <a href="index.html" class="text-2xl font-bold tracking-wide">
        <span class="text-white">PL</span><span style="color: #22d3ee;">AI</span><span class="text-gray-500">-</span><span class="text-gray-400">STOCK</span>
      </a>
      
      <div class="flex items-center rounded-full px-4 py-2" style="background-color: rgba(30, 41, 59, 0.8); border: 1px solid #334155;">
        <input type="text" id="searchInput" placeholder="ì¢…ëª© ê²€ìƒ‰" class="w-48 outline-none text-sm bg-transparent text-white placeholder-gray-500"/>
        <button id="searchBtn" class="ml-2 p-1 rounded-full hover:bg-gray-700 transition-colors">
          <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        </button>
      </div>
    </header>

    <!-- ì¢…ëª© ì •ë³´ ë°” -->
    <div class="px-6 py-4 border-b" style="border-color: #334155;">
      <div class="flex items-center gap-4 flex-wrap">
        <h1 id="tickerName" class="text-3xl font-bold text-white">-</h1>
        <span id="companyName" class="text-gray-400 text-lg">ë¡œë”© ì¤‘...</span>
        <span id="currentPrice" class="text-2xl font-semibold text-gray-400 ml-auto">-</span>
        <span id="priceChange" class="text-gray-400">-</span>
      </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <main class="p-6">
      
      <!-- ì°¨íŠ¸ ì„¹ì…˜ -->
      <section class="rounded-xl p-6 mb-6" style="background-color: rgba(30, 41, 59, 0.5); border: 1px solid #334155;">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-white">ğŸ“ˆ ì°¨íŠ¸</h2>
          <div id="chartPeriod" class="flex gap-2">
            <button class="period-btn px-3 py-1 rounded text-sm bg-cyan-600 text-white" data-period="compact">3ê°œì›”</button>
            <button class="period-btn px-3 py-1 rounded text-sm bg-gray-700 text-gray-300 hover:bg-gray-600" data-period="full">ì „ì²´</button>
          </div>
        </div>
        <div id="chartContainer" class="w-full rounded-lg flex items-center justify-center" style="background-color: #0f172a; height: 480px;">
          <div class="text-center">
            <div class="loading-spinner mx-auto mb-3"></div>
            <span class="text-gray-500">ì°¨íŠ¸ ë¡œë”© ì¤‘...</span>
          </div>
        </div>
      </section>

      <!-- AI ë¶„ì„ ì„¹ì…˜ -->
      <section class="rounded-xl p-6" style="background-color: rgba(30, 41, 59, 0.5); border: 1px solid #334155;">
        <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
          <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
          </svg>
          AI ë¶„ì„ ë¦¬í¬íŠ¸
        </h2>
        
        <div id="analysisGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>

        <div class="rounded-lg p-4" style="background-color: #0f172a;">
          <h3 class="text-cyan-400 font-semibold mb-2">ğŸ’¡ ì¢…í•© ì˜ê²¬</h3>
          <p id="summaryAnalysis" class="text-gray-300 leading-relaxed">ë¶„ì„ ëŒ€ê¸° ì¤‘...</p>
        </div>
      </section>

    </main>
  </div>

  <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.min.js"></script>
  <script src="ticker_search.js"></script>
  <script src="alpha_vantage_api_call.js"></script>
  
  <script>
    // ===== ì „ì—­ ë³€ìˆ˜ =====
    let chart = null;
    let candleSeries = null;
    let volumeSeries = null;
    let currentTicker = null;
    let currentStockData = null;

    // ===== ë¶„ì„ ì¹´ë“œ ì„¤ì • =====
    const ANALYSIS_CARDS = [
      { id: 'trend', icon: 'ğŸ“ˆ', title: 'ì¶”ì„¸ ë¶„ì„', type: 'trend' },
      { id: 'candle', icon: 'ğŸ•¯ï¸', title: 'ìº”ë“¤ íŒ¨í„´', type: 'candle' },
      { id: 'volume', icon: 'ğŸ“Š', title: 'ê±°ë˜ëŸ‰', type: 'volume' },
      { id: 'macd', icon: 'ğŸ“‰', title: 'MACD', type: 'macd' },
      { id: 'rsi', icon: 'âš¡', title: 'RSI', type: 'rsi' },
      { id: 'stoch', icon: 'ğŸ¯', title: 'ìŠ¤í† ìºìŠ¤í‹±', type: 'stoch' },
    ];

    // ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
    function formatNumber(num) {
      if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    function showLoading(elementId, message = 'ë¡œë”© ì¤‘...') {
      const el = document.getElementById(elementId);
      if (el) el.innerHTML = `<span class="text-gray-400 animate-pulse">${message}</span>`;
    }

    function showError(elementId, message) {
      const el = document.getElementById(elementId);
      if (el) el.innerHTML = `<span class="text-red-400">âŒ ${message}</span>`;
    }

    // ===== ë¶„ì„ ì¹´ë“œ ë Œë”ë§ =====
    function renderAnalysisCards() {
      const grid = document.getElementById('analysisGrid');
      if (!grid) return;
      
      grid.innerHTML = ANALYSIS_CARDS.map(card => `
        <div class="analysis-card rounded-lg p-4" style="background-color: #0f172a; border: 1px solid #334155;">
          <h3 class="text-cyan-400 font-semibold mb-2">${card.icon} ${card.title}</h3>
          <p id="${card.id}Analysis" class="text-gray-300 text-sm leading-relaxed">ë¶„ì„ ëŒ€ê¸° ì¤‘...</p>
        </div>
      `).join('');
    }

    // ===== ì°¨íŠ¸ ë Œë”ë§ =====
    function renderChart(stockData) {
      const container = document.getElementById('chartContainer');
      if (!container) {
        console.error('chartContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
      container.innerHTML = '';
      if (chart) {
        chart.remove();
        chart = null;
      }

      // ì»¨í…Œì´ë„ˆ í¬ê¸° í™•ì¸
      const width = container.clientWidth || 800;
      const height = 480;

      try {
        // ì°¨íŠ¸ ìƒì„±
        chart = LightweightCharts.createChart(container, {
          width: width,
          height: height,
          layout: {
            background: { color: '#0f172a' },
            textColor: '#9ca3af',
          },
          grid: {
            vertLines: { color: '#1e293b' },
            horzLines: { color: '#1e293b' },
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
          },
          rightPriceScale: {
            borderColor: '#334155',
            scaleMargins: { top: 0.1, bottom: 0.25 },
          },
          timeScale: {
            borderColor: '#334155',
            timeVisible: false,
            rightOffset: 5,
          },
          localization: {
            locale: 'ko-KR',
          },
        });

        // ìº”ë“¤ ì‹œë¦¬ì¦ˆ
        candleSeries = chart.addCandlestickSeries({
          upColor: '#22c55e',
          downColor: '#ef4444',
          borderUpColor: '#22c55e',
          borderDownColor: '#ef4444',
          wickUpColor: '#22c55e',
          wickDownColor: '#ef4444',
        });

        // ê±°ë˜ëŸ‰ ì‹œë¦¬ì¦ˆ
        volumeSeries = chart.addHistogramSeries({
          color: '#3b82f6',
          priceFormat: { type: 'volume' },
          priceScaleId: 'volume',
        });

        chart.priceScale('volume').applyOptions({
          scaleMargins: { top: 0.8, bottom: 0 },
          borderVisible: false,
        });

        // ë°ì´í„° ë³€í™˜ ë° ì •ë ¬
        const chartData = Object.entries(stockData.data)
          .map(([dateStr, values]) => ({
            time: dateStr,
            open: parseFloat(values['1. open']),
            high: parseFloat(values['2. high']),
            low: parseFloat(values['3. low']),
            close: parseFloat(values['4. close']),
            volume: parseFloat(values['5. volume']),
          }))
          .filter(d => !isNaN(d.open) && !isNaN(d.close))
          .sort((a, b) => new Date(a.time) - new Date(b.time));

        if (chartData.length === 0) {
          showError('chartContainer', 'ìœ íš¨í•œ ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤');
          return;
        }

        // ìº”ë“¤ ë°ì´í„° ì„¤ì •
        candleSeries.setData(chartData.map(d => ({
          time: d.time,
          open: d.open,
          high: d.high,
          low: d.low,
          close: d.close,
        })));

        // ê±°ë˜ëŸ‰ ë°ì´í„° ì„¤ì • (ìƒ‰ìƒ êµ¬ë¶„)
        volumeSeries.setData(chartData.map(d => ({
          time: d.time,
          value: d.volume,
          color: d.close >= d.open ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)',
        })));

        // ì°¨íŠ¸ ì˜ì—­ ë§ì¶¤
        chart.timeScale().fitContent();

        // í˜„ì¬ê°€ ì—…ë°ì´íŠ¸
        updatePriceInfo(chartData);

        // ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ëŸ¬
        const resizeHandler = () => {
          if (chart && container) {
            chart.resize(container.clientWidth, height);
          }
        };
        window.addEventListener('resize', resizeHandler);

        console.log(`ì°¨íŠ¸ ë Œë”ë§ ì™„ë£Œ: ${chartData.length}ê°œ ë°ì´í„°`);

      } catch (error) {
        console.error('ì°¨íŠ¸ ë Œë”ë§ ì˜¤ë¥˜:', error);
        showError('chartContainer', `ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨: ${error.message}`);
      }
    }

    // ===== ê°€ê²© ì •ë³´ ì—…ë°ì´íŠ¸ =====
    function updatePriceInfo(chartData) {
      if (!chartData || chartData.length === 0) return;

      const latest = chartData[chartData.length - 1];
      const prev = chartData.length > 1 ? chartData[chartData.length - 2] : latest;
      const change = latest.close - prev.close;
      const changePercent = ((change / prev.close) * 100).toFixed(2);
      const isUp = change >= 0;

      const priceEl = document.getElementById('currentPrice');
      const changeEl = document.getElementById('priceChange');

      if (priceEl) {
        priceEl.textContent = `$${latest.close.toFixed(2)}`;
        priceEl.className = `text-2xl font-semibold ml-auto ${isUp ? 'text-green-400' : 'text-red-400'}`;
      }

      if (changeEl) {
        priceEl.textContent = `$${latest.close.toFixed(2)}`;
        changeEl.textContent = `${isUp ? '+' : ''}${change.toFixed(2)} (${isUp ? '+' : ''}${changePercent}%)`;
        changeEl.className = isUp ? 'text-green-400' : 'text-red-400';
      }
    }

    // ===== ë°ì´í„° ë¡œë“œ =====
    async function loadChartData(ticker, outputSize = 'compact') {
      const container = document.getElementById('chartContainer');
      if (!container) {
        console.error('chartContainer ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      // ë¡œë”© í‘œì‹œ
      container.innerHTML = `
        <div class="text-center">
          <div class="loading-spinner mx-auto mb-3"></div>
          <span class="text-gray-500">ì°¨íŠ¸ ë°ì´í„° ë¡œë”© ì¤‘...</span>
        </div>
      `;

      try {
        // Alpha Vantage API í˜¸ì¶œ
        const stockData = await getDailyData(ticker, outputSize);

        if (!stockData.success) {
          showError('chartContainer', stockData.error || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          return;
        }

        if (!stockData.data || Object.keys(stockData.data).length === 0) {
          showError('chartContainer', 'ì£¼ê°€ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
          return;
        }

        currentStockData = stockData;
        
        // ì°¨íŠ¸ ë Œë”ë§
        renderChart(stockData);
        
        // AI ë¶„ì„ ì‹¤í–‰
        runAllAnalysis(stockData);

      } catch (error) {
        console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
        showError('chartContainer', error.message);
      }
    }

    // ===== ê°œë³„ ë¶„ì„ API í˜¸ì¶œ =====
    async function fetchAnalysis(card, stockData) {
      const element = document.getElementById(`${card.id}Analysis`);
      if (!element) return;

      element.innerHTML = '<span class="animate-pulse">ë¶„ì„ ì¤‘...</span>';

      try {
        const response = await fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ticker: currentTicker,
            analysisType: card.type,
            stockData: stockData
          })
        });

        const data = await response.json();
        element.textContent = data.success ? data.analysis : `ë¶„ì„ ì‹¤íŒ¨: ${data.error}`;

      } catch (error) {
        element.textContent = `ì˜¤ë¥˜: ${error.message}`;
      }
    }

    // ===== ì¢…í•© ì˜ê²¬ ë¶„ì„ =====
    async function fetchSummaryAnalysis(stockData) {
      const element = document.getElementById('summaryAnalysis');
      if (!element) return;

      element.innerHTML = '<span class="animate-pulse">ì¢…í•© ì˜ê²¬ ìƒì„± ì¤‘...</span>';

      try {
        const response = await fetch('/api/analyze', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ticker: currentTicker,
            analysisType: 'summary',
            stockData: stockData
          })
        });

        const data = await response.json();
        element.textContent = data.success ? data.analysis : `ë¶„ì„ ì‹¤íŒ¨: ${data.error}`;

      } catch (error) {
        element.textContent = `ì˜¤ë¥˜: ${error.message}`;
      }
    }

    // ===== ëª¨ë“  ë¶„ì„ ì‹¤í–‰ =====
    async function runAllAnalysis(stockData) {
      await Promise.all([
        ...ANALYSIS_CARDS.map(card => fetchAnalysis(card, stockData)),
        fetchSummaryAnalysis(stockData)
      ]);
    }

    // ===== ê²€ìƒ‰ ê¸°ëŠ¥ =====
    async function handleSearch() {
      const query = document.getElementById('searchInput')?.value.trim();
      if (!query) return;

      try {
        const tickerResult = await searchTicker(query);
        if (tickerResult.success) {
          window.location.href = `analysis.html?ticker=${tickerResult.ticker}`;
        } else {
          alert('í‹°ì»¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    // ===== ê¸°ê°„ ë²„íŠ¼ ì´ë²¤íŠ¸ =====
    function initPeriodButtons() {
      document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.period-btn').forEach(b => {
            b.classList.remove('bg-cyan-600', 'text-white');
            b.classList.add('bg-gray-700', 'text-gray-300');
          });
          this.classList.remove('bg-gray-700', 'text-gray-300');
          this.classList.add('bg-cyan-600', 'text-white');

          const period = this.dataset.period;
          if (currentTicker) {
            loadChartData(currentTicker, period);
          }
        });
      });
    }

    // ===== ì´ˆê¸°í™” =====
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM ë¡œë“œ ì™„ë£Œ');

      // Lightweight Charts ë¡œë“œ í™•ì¸
      if (typeof LightweightCharts === 'undefined') {
        showError('chartContainer', 'Lightweight Charts ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        return;
      }

      // URLì—ì„œ í‹°ì»¤ ì¶”ì¶œ
      const urlParams = new URLSearchParams(window.location.search);
      const ticker = urlParams.get('ticker');

      // UI ì´ˆê¸°í™”
      renderAnalysisCards();
      initPeriodButtons();

      // ê²€ìƒ‰ ì´ë²¤íŠ¸
      document.getElementById('searchInput')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleSearch();
      });
      document.getElementById('searchBtn')?.addEventListener('click', handleSearch);

      // í‹°ì»¤ê°€ ìˆìœ¼ë©´ ë°ì´í„° ë¡œë“œ
      if (ticker) {
        currentTicker = ticker.toUpperCase();
        document.getElementById('tickerName').textContent = currentTicker;

        // í•œêµ­ ì£¼ì‹ ì²´í¬
        if (ticker.includes('.KS') || ticker.includes('.KQ') || /^\d{6}$/.test(ticker)) {
          showError('chartContainer', 'í˜„ì¬ ë¯¸êµ­ ì£¼ì‹ë§Œ ì§€ì›ë©ë‹ˆë‹¤. í•œêµ­ ì£¼ì‹ì€ ì¶”í›„ ì§€ì› ì˜ˆì •ì…ë‹ˆë‹¤.');
          document.getElementById('companyName').textContent = 'í•œêµ­ ì£¼ì‹ ë¯¸ì§€ì›';
        } else {
          document.getElementById('companyName').textContent = 'ë°ì´í„° ë¡œë”© ì¤‘...';
          loadChartData(currentTicker);
        }
      } else {
        showError('chartContainer', 'í‹°ì»¤ê°€ ì§€ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. URLì— ?ticker=AAPL í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”.');
      }
    });
  </script>
</body>
</html>
